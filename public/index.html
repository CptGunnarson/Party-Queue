<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotify Party Queue 🎶</title>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #000;
        color: #fff;
        text-align: center;
        padding: 30px;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #1db954;
      }

      p {
        color: #aaa;
      }

      #search {
        width: 90%;
        max-width: 400px;
        padding: 12px;
        border: 2px solid #1db954;
        border-radius: 8px;
        font-size: 1rem;
        background-color: #111;
        color: white;
        margin-top: 20px;
      }

      #search:focus {
        outline: none;
        border-color: #1ed760;
      }

      #results {
        margin-top: 25px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
      }

      .track {
        background: #111;
        border: 1px solid #1db95433;
        border-radius: 10px;
        padding: 10px;
        width: 90%;
        max-width: 420px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: transform 0.15s ease;
      }

      .track:hover {
        transform: scale(1.02);
      }

      .track img {
        width: 55px;
        height: 55px;
        border-radius: 6px;
      }

      .track-info {
        text-align: left;
        flex: 1;
        margin-left: 12px;
      }

      .track-info strong {
        color: #fff;
      }

      .track-info div {
        font-size: 0.9rem;
        color: #aaa;
      }

      .track button {
        background: #1db954;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
      }

      .track button:hover {
        background: #17a84b;
      }

      #message {
        margin-top: 25px;
        color: #ff4d4d;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>🎉 Spotify Party Queue</h1>
    <p>Suche nach Songs und füge sie deiner Party-Warteschlange hinzu!</p>

    <input
      type="text"
      id="search"
      placeholder="Song oder Künstler eingeben..."
      autocomplete="off"
    />

    <div id="results"></div>
    <div id="message"></div>

    <script>
      const searchInput = document.getElementById("search");
      const resultsDiv = document.getElementById("results");
      const messageDiv = document.getElementById("message");
      let timeout = null;

      // 🔁 Auto-Refresh alle 60 Sekunden (damit UI aktuell bleibt)
      setInterval(() => {
        if (searchInput.value.trim().length > 0) {
          triggerSearch();
        }
      }, 60000);

      // 🔎 Live-Suche beim Tippen
      searchInput.addEventListener("input", () => {
        clearTimeout(timeout);
        timeout = setTimeout(() => triggerSearch(), 400);
      });

      function triggerSearch() {
        const query = searchInput.value.trim();
        if (!query) {
          resultsDiv.innerHTML = "";
          return;
        }

        fetch(`/search?q=${encodeURIComponent(query)}`)
          .then((res) => res.json())
          .then((tracks) => {
            if (tracks.error) {
              showMessage(tracks.error);
              return;
            }

            resultsDiv.innerHTML = "";
            tracks.forEach((track) => {
              const div = document.createElement("div");
              div.className = "track";
              div.innerHTML = `
                <img src="${track.album.images[0]?.url || ""}" alt="cover">
                <div class="track-info">
                  <strong>${track.name}</strong>
                  <div>${track.artists.map((a) => a.name).join(", ")}</div>
                </div>
                <button data-uri="${track.uri}">+</button>
              `;
              resultsDiv.appendChild(div);
            });
          })
          .catch(() => showMessage("Fehler bei der Suche."));
      }

      // ➕ Song zur Queue hinzufügen
      resultsDiv.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
          const uri = e.target.getAttribute("data-uri");
          fetch("/add-to-queue", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ uri }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                showMessage("✅ Song wurde hinzugefügt!");
              } else if (data.error) {
                showMessage("⚠️ " + data.error);
                if (data.error.includes("verbinden")) {
                  setTimeout(() => {
                    window.location.href = "/login";
                  }, 2000);
                }
              }
            })
            .catch(() => showMessage("Fehler beim Hinzufügen."));
        }
      });

      function showMessage(msg) {
        messageDiv.textContent = msg;
        setTimeout(() => (messageDiv.textContent = ""), 4000);
      }
    </script>
  </body>
</html>
