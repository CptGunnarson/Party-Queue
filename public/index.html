<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Spotify Party Queue 🎶</title>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background: linear-gradient(135deg, #191414, #1db954);
        color: white;
        text-align: center;
        padding: 30px;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 10px;
      }

      #search {
        width: 90%;
        max-width: 400px;
        padding: 10px;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        margin-top: 20px;
      }

      #results {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 10px;
        width: 90%;
        max-width: 400px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .track img {
        width: 50px;
        height: 50px;
        border-radius: 5px;
      }

      .track-info {
        text-align: left;
        flex: 1;
        margin-left: 10px;
      }

      .track button {
        background: #1db954;
        border: none;
        padding: 10px 14px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.3s;
      }

      .track button:hover {
        background: #17a84b;
      }

      #message {
        margin-top: 20px;
        color: #ffdddd;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>🎉 Spotify Party Queue</h1>
    <p>Suche nach Songs und füge sie deiner Party-Warteschlange hinzu!</p>

    <input
      type="text"
      id="search"
      placeholder="Song oder Künstler eingeben..."
      autocomplete="off"
    />

    <div id="results"></div>
    <div id="message"></div>

    <script>
      const searchInput = document.getElementById("search");
      const resultsDiv = document.getElementById("results");
      const messageDiv = document.getElementById("message");

      let timeout = null;

      // 🔎 Live-Suche beim Tippen
      searchInput.addEventListener("input", () => {
        clearTimeout(timeout);
        const query = searchInput.value.trim();

        if (!query) {
          resultsDiv.innerHTML = "";
          return;
        }

        timeout = setTimeout(() => {
          fetch(`/search?q=${encodeURIComponent(query)}`)
            .then((res) => res.json())
            .then((tracks) => {
              if (tracks.error) {
                showMessage(tracks.error);
                return;
              }

              resultsDiv.innerHTML = "";
              tracks.forEach((track) => {
                const div = document.createElement("div");
                div.className = "track";
                div.innerHTML = `
                  <img src="${track.album.images[0]?.url || ""}" alt="cover">
                  <div class="track-info">
                    <div><strong>${track.name}</strong></div>
                    <div>${track.artists.map((a) => a.name).join(", ")}</div>
                  </div>
                  <button data-uri="${track.uri}">+</button>
                `;
                resultsDiv.appendChild(div);
              });
            })
            .catch(() => showMessage("Fehler bei der Suche."));
        }, 400);
      });

      // ➕ Song zur Queue hinzufügen
      resultsDiv.addEventListener("click", (e) => {
        if (e.target.tagName === "BUTTON") {
          const uri = e.target.getAttribute("data-uri");
          fetch("/add-to-queue", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ uri }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                showMessage("✅ Song wurde hinzugefügt!");
              } else if (data.error) {
                showMessage("⚠️ " + data.error);
                if (data.error.includes("verbinden")) {
                  setTimeout(() => {
                    window.location.href = "/login";
                  }, 1500);
                }
              }
            })
            .catch(() => showMessage("Fehler beim Hinzufügen."));
        }
      });

      function showMessage(msg) {
        messageDiv.textContent = msg;
        setTimeout(() => (messageDiv.textContent = ""), 4000);
      }
    </script>
  </body>
</html>
